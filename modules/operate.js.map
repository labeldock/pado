{"version":3,"sources":["../.src/modules/operate.js"],"names":["operate","PARENT_OUTPUT_UPDATED","input","output","concurrent","rescue","limitInput","limitOutput","parent","undefined","children","inputs","outputs","Number","POSITIVE_INFINITY","current","Object","defineProperty","get","limit","length","inputOutput","kickStart","avaliableQueLength","avaliableOutputCount","Array","fill","forEach","entry","shift","outputHandle","formInputDataum","push","child","emit","value","pushData","d","eventName","payload","avaliablePullCount","pullData","pull","datum","pullLength","splice","deep","parentOperate","cloneOperate","operateFunction","clone","prototype","append","remove","index","indexOf","option","assign"],"mappings":"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","sourcesContent":["import { \n  asArray,\n  isNumber\n} from '../functions'\n\nexport const operate = (function (){\n  const PARENT_OUTPUT_UPDATED = \"ParentOutputUpdated\"\n  \n  const operate = function ({ input, output, concurrent, rescue, limitInput, limitOutput }){\n    this.parent = undefined\n    this.children = []\n    this.inputs = []\n    this.outputs = []\n    this.limitInput = isNumber(limitInput) || limitInput > 0 ? limitInput : Number.POSITIVE_INFINITY\n    this.limitOutput = isNumber(limitOutput) || limitOutput > 0 ? limitOutput : Number.POSITIVE_INFINITY\n    \n    //\n    let current = 0\n    concurrent = isNumber(concurrent) || concurrent > 0 ? concurrent : 1\n    \n    Object.defineProperty(this, \"avaliablePullCount\", {\n      get: ()=>{\n        let limit = this.limitInput - this.inputs.length\n        if(limit < 0) limit = 0\n        return limit\n      }\n    })\n    \n    Object.defineProperty(this, \"avaliableOutputCount\", {\n      get: ()=>{\n        return this.limitOutput + current + this.outputs.length\n      }\n    })\n    \n    const inputOutput = { input, output }\n    \n    const kickStart = ()=>{\n      let avaliableQueLength = concurrent - current\n      \n      // 작동가능한 큐\n      if(avaliableQueLength < 1){\n        return\n      }\n      \n      // input의 길이로 확인하여 실행 가능한 큐\n      if(avaliableQueLength > this.inputs.length){\n        avaliableQueLength = this.inputs.length\n      }\n      \n      // output의 제한을 확인하여 사용 가능한 큐\n      if(avaliableQueLength > this.avaliableOutputCount){\n        avaliableQueLength = this.avaliableOutputCount\n      }\n      \n      if(avaliableQueLength < 1){\n        return\n      }\n      \n      Array(avaliableQueLength).fill(inputOutput).forEach(async ({input, output})=>{\n        let entry = this.inputs.shift()\n        current++\n        \n        const outputHandle = async (formInputDataum)=>{\n          /* TODO:lint\n          if(typeof output === \"function\"){\n            const out = await output({ entry: formInputDataum })\n          }\n          */\n          \n          this.outputs.push(formInputDataum)\n          current--\n        \n          this.children.forEach(child=>child.emit(PARENT_OUTPUT_UPDATED))\n          kickStart()\n        }\n        \n        if(input){\n          try {\n            outputHandle(await input({ entry }))\n          } catch (e){\n            if(typeof rescue === \"function\"){\n              rescue(e)\n            } else {\n              throw e\n            }\n            current--\n          }\n        } else {\n          outputHandle(entry)\n        }\n      })\n    }\n\n    Object.defineProperty(this, \"push\", {\n      value: (pushData)=>{\n        this.inputs.push(pushData)\n        kickStart()\n        return this\n      }\n    })\n    \n    Object.defineProperty(this, \"concat\", {\n      value: (pushData)=>{\n        asArray(pushData).forEach(d=>this.inputs.push(d))\n        kickStart()\n        return this\n      }\n    })\n    \n    Object.defineProperty(this, \"emit\", {\n      value: (eventName, payload)=>{\n        switch (eventName){\n          case PARENT_OUTPUT_UPDATED:\n            if(this.avaliablePullCount < 1) return\n            let pullData = this.parent.pull(this.avaliablePullCount)\n            if(pullData.length < 1) return\n            pullData.forEach(datum=>this.inputs.push(datum))\n            kickStart()\n            break\n        }\n      }\n    })\n    \n    Object.defineProperty(this, \"pull\", {\n      value: (pullLength)=>{\n        if(!(isNumber(pullLength) || pullLength == Number.POSITIVE_INFINITY)) return []\n        const pullData = this.outputs.splice(0, pullLength)\n        //pullData.length && kickStart();\n        return pullData\n      }\n    })\n    \n    Object.defineProperty(this, \"clone\", {\n      value: (deep = true, parentOperate)=>{\n        let cloneOperate = operateFunction({ input, output, concurrent, rescue, limitInput, limitOutput })\n        \n        deep === true && this.children.forEach(child=>{\n          child.clone(true, cloneOperate)\n        })\n        \n        return cloneOperate\n      }\n    })\n  }\n  \n  operate.prototype = {\n    append: function (child){\n      child.parent = this\n      this.children.push(child)\n      return this\n    },\n    remove: function (child){\n      let index = this.children.indexOf(child)\n      if(index < 0) return this\n      child.parent = undefined\n      this.children.splice(index, 1)\n    },\n    operate: function (option){\n      return this.append(operateFunction(option))\n    }\n  }\n  \n  const operateFunction = function (option){\n    return new operate(Object.assign({}, option))\n  }\n  \n  return operateFunction\n}())\n"],"file":"operate.js"}